#!/bin/bash

# æ”¹è¿›åŠŸèƒ½ç›‘æ§è„šæœ¬
# ç”¨äºè§‚å¯Ÿæ–°å®æ–½çš„3é¡¹é«˜ä¼˜å…ˆçº§æ”¹è¿›çš„è¿è¡Œæ•ˆæœ

echo "ğŸ” NOFX æ”¹è¿›åŠŸèƒ½å®æ—¶ç›‘æ§"
echo "================================"
echo "ç›‘æ§é¡¹ç›®:"
echo "  âœ… 1. è®¢å•å»é‡æœºåˆ¶ï¼ˆ30åˆ†é’Ÿçª—å£ï¼‰"
echo "  âœ… 2. åŠ¨æ€æ­¢æŸæ—¶é—´ç­–ç•¥ï¼ˆæ³¢åŠ¨æ€§è‡ªé€‚åº”ï¼‰"
echo "  âœ… 3. TP/SLåŒæ­¥éªŒè¯ï¼ˆæ¯5å‘¨æœŸï¼‰"
echo "================================"
echo ""

LOG_FILE="/tmp/nofx.log"

# æ£€æŸ¥æ—¥å¿—æ–‡ä»¶æ˜¯å¦å­˜åœ¨
if [ ! -f "$LOG_FILE" ]; then
    echo "âŒ æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨: $LOG_FILE"
    exit 1
fi

echo "ğŸ“Š å¯åŠ¨å®æ—¶ç›‘æ§ï¼ˆæŒ‰ Ctrl+C é€€å‡ºï¼‰..."
echo ""

# è®¡æ•°å™¨
count=0

while true; do
    clear
    count=$((count + 1))
    
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘     ğŸ” NOFX æ”¹è¿›åŠŸèƒ½å®æ—¶ç›‘æ§ - åˆ·æ–°æ¬¡æ•°: $count              "
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    echo "â° æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
    echo ""
    
    # 1. è®¢å•å»é‡æ£€æŸ¥
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "âœ… 1. è®¢å•å»é‡æœºåˆ¶ï¼ˆ30åˆ†é’Ÿçª—å£ï¼‰"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    recent_count=$(tail -500 "$LOG_FILE" | grep -c "recently filled order" 2>/dev/null || echo "0")
    duplicate_prevented=$(tail -500 "$LOG_FILE" | grep "recently filled order" | tail -3)
    
    if [ "$recent_count" -gt 0 ]; then
        echo "ğŸ¯ å‘ç°å»é‡æ“ä½œ: $recent_count æ¬¡"
        echo "$duplicate_prevented"
    else
        echo "â„¹ï¸  æš‚æœªè§¦å‘å»é‡ï¼ˆæ— æœ€è¿‘æˆäº¤è®¢å•å†²çªï¼‰"
    fi
    echo ""
    
    # 2. åŠ¨æ€æ­¢æŸæ³¢åŠ¨æ€§è‡ªé€‚åº”
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "âœ… 2. åŠ¨æ€æ­¢æŸæ—¶é—´ç­–ç•¥ï¼ˆæ³¢åŠ¨æ€§è‡ªé€‚åº”ï¼‰"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    high_vol=$(tail -500 "$LOG_FILE" | grep -c "High volatility.*using 10min" 2>/dev/null || echo "0")
    low_vol=$(tail -500 "$LOG_FILE" | grep -c "Low volatility.*using 3min" 2>/dev/null || echo "0")
    adaptive_updates=$(tail -500 "$LOG_FILE" | grep "AdaptiveStop.*SL updated.*volatility" | tail -3)
    
    echo "ğŸ“ˆ é«˜æ³¢åŠ¨ç­–ç•¥è§¦å‘: $high_vol æ¬¡ï¼ˆ10åˆ†é’Ÿçª—å£ï¼‰"
    echo "ğŸ“‰ ä½æ³¢åŠ¨ç­–ç•¥è§¦å‘: $low_vol æ¬¡ï¼ˆ3åˆ†é’Ÿçª—å£ï¼‰"
    
    if [ -n "$adaptive_updates" ]; then
        echo ""
        echo "æœ€è¿‘çš„åŠ¨æ€æ­¢æŸæ›´æ–°:"
        echo "$adaptive_updates"
    else
        echo "â„¹ï¸  ç­‰å¾…æŒä»“è§¦å‘åŠ¨æ€æ­¢æŸ..."
    fi
    echo ""
    
    # 3. TP/SLåŒæ­¥éªŒè¯
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "âœ… 3. TP/SLåŒæ­¥éªŒè¯ï¼ˆæ¯5å‘¨æœŸï¼‰"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    sync_checks=$(tail -500 "$LOG_FILE" | grep -c "TPSLSync.*Checking.*positions" 2>/dev/null || echo "0")
    sync_success=$(tail -500 "$LOG_FILE" | grep "TPSLSync.*synced successfully" | tail -1)
    sync_errors=$(tail -500 "$LOG_FILE" | grep "TPSLSync.*Failed" | tail -3)
    
    echo "ğŸ” åŒæ­¥æ£€æŸ¥æ‰§è¡Œ: $sync_checks æ¬¡"
    
    if [ -n "$sync_success" ]; then
        echo "âœ… $sync_success"
    fi
    
    if [ -n "$sync_errors" ]; then
        echo ""
        echo "âš ï¸  åŒæ­¥é”™è¯¯:"
        echo "$sync_errors"
    else
        echo "â„¹ï¸  æš‚æ— åŒæ­¥é”™è¯¯"
    fi
    echo ""
    
    # ç³»ç»ŸçŠ¶æ€
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ“Š ç³»ç»ŸçŠ¶æ€"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    # è·å–æœ€æ–°çš„äº¤æ˜“å‘¨æœŸä¿¡æ¯
    latest_cycle=$(tail -100 "$LOG_FILE" | grep "ğŸ¤– AI will make full decisions" | tail -1)
    if [ -n "$latest_cycle" ]; then
        echo "ğŸ”„ æœ€æ–°å‘¨æœŸ: $latest_cycle"
    fi
    
    # è·å–æŒä»“ä¿¡æ¯
    positions=$(tail -100 "$LOG_FILE" | grep "Account equity" | tail -1)
    if [ -n "$positions" ]; then
        echo "$positions"
    fi
    
    echo ""
    echo "ğŸ’¡ æç¤º: ç›‘æ§è„šæœ¬æ¯10ç§’åˆ·æ–°ä¸€æ¬¡ï¼ŒæŒ‰ Ctrl+C é€€å‡º"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    # ç­‰å¾…10ç§’ååˆ·æ–°
    sleep 10
done
